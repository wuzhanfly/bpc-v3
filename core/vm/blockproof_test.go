package vm

import (
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/common/hexutil"
	"github.com/stretchr/testify/require"
	"math/big"
	"testing"
)

type verifyBlockResult struct {
	blockNumber uint64
	blockHash   common.Hash
	signer      common.Address
	validators  []common.Address
	parentHash  common.Hash
}

func doVerifyParliaBlock(t *testing.T, chainId uint64, blockProof []byte) verifyBlockResult {
	contract := &verifyParliaBlock{}
	input, err := verifyParliaBlockInput.Pack(big.NewInt(int64(chainId)), blockProof, uint32(200))
	require.NoError(t, err)
	out, err := contract.Run(input)
	require.NoError(t, err)
	result, err := verifyParliaBlockOutput.Unpack(out)
	require.NoError(t, err)
	return verifyBlockResult{
		blockHash:   result[0].([32]byte),
		blockNumber: result[1].(uint64),
		signer:      result[2].(common.Address),
		validators:  result[3].([]common.Address),
		parentHash:  result[4].([32]byte),
	}
}

func Test_VerifyBlockProof(t *testing.T) {
	var res verifyBlockResult
	// block 13082000 with validators in extra data
	res = doVerifyParliaBlock(t, 56, hexutil.MustDecode("0xf90403a0e06d1e696e78bef7671cc0936b4428d9f6b3aa5ef1dd1b21620fca6742d6faf1a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d493479470f657164e5b75689b64b7fd1fa275f334f28e18a04f954c11b1721ed1816b4eef4a57ba99c7288f1a5dbaf09f375efbb888bc6a8ea088d550352ebf720520dc48b2a16a82da57524145862bbedd46f2d22166bf7069a0ff6fc0e069e4e43b42d84b218d3a8bbead88cc5f06044c8f6cb64fa446520c26b90100fffff77feefbffffffbffb7dfffffffffffffffebfffff7ffef5fffffefb7ffbfeffffff75fdfffb7fffbfbfdf5fffeffff7ffffffcf7f7fffffb7bdffffffffffbfffffbfeffffffff7ffddb7ffffefffff9ffffffffedfffffffffffbffffffff5fffff3fff7fbeeef3f7ffdefffffbbbfffebefbffffffcfb3fffbfdffdffbffdffeedffffffff7ffffddffffffbff7fdfc5fb7f6dffdfbffef7fff6dffffffffffbefffffff96efff7bdff7fefdfbfbfde7f7fcfdffdffffbdffffeffbfff7b7ffffbffdd5de7ffbfffdffffd7bffffdf7ffef7fffffffeffffffffffff3fdffffedfdfdfddded7fd3fef7fedfdffffbffff5fffffffff3bdebfffffffbf0283c79d908405f5e1008405ee8b078461a65ec5b90205d883010105846765746888676f312e31372e32856c696e7578000000c3167bdf2465176c461afb316ebc773c61faee85a6515daa295e26495cef6f69dfa69911d9d8e4f3bbadb89b29a97c6effb8a411dabc6adeefaa84f5067c8bbe2a7cdd959bfe8d9487b2a43b33565295a698f7e22d4c407bbe49438ed859fe965b140dcf1aab71a93f349bbafec1551819b8be1efea2fc46ca749aa14430b3230294d12c6ab2aac5c2cd68e80b16b581685b1ded8013785d6623cc18d214320b6bb6475970f657164e5b75689b64b7fd1fa275f334f28e187ae2f5b9e386cd1b50a4550696d957cb4900f03a8b6c8fd93d6f4cea42bbb345dbc6f0dfdb5bec739bb832254baf4e8b4cc26bd2b52b31389b56e98b9f8ccdafcc39f3c7d6ebf637c9151673cbc36b88a6f79b60359f141df90a0c745125b131caaffd12b8f7166496996a7da21cf1f1b04d9b3e26a3d077be807dddb074639cd9fa61b47676c064fc50d62cce2fd7544e0b2cc94692d4a704debef7bcb61328e2d3a739effcd3a99387d015e260eefac72ebea1e9ae3261a475a27bb1028f140bc2a7c843318afdea0a6e3c511bbd10f4519ece37dc24887e11b55dee226379db83cffc681495730c11fdde79ba4c0c58ec4877d8453b381c8c1c6950bd2ce0a4888e4cf2efe677abbbe1c83ce98206293d6e8ae9adbd85b3b4e1afd653ff03f5ab96e2b41c6adb77d42dd499574a1500a00000000000000000000000000000000000000000000000000000000000000000880000000000000000"))
	require.Equal(t, res.signer, common.HexToAddress("0x70f657164e5b75689b64b7fd1fa275f334f28e18"))
	require.Equal(t, res.validators, []common.Address{
		common.HexToAddress("0x2465176c461afb316ebc773c61faee85a6515daa"),
		common.HexToAddress("0x295e26495cef6f69dfa69911d9d8e4f3bbadb89b"),
		common.HexToAddress("0x29a97c6effb8a411dabc6adeefaa84f5067c8bbe"),
		common.HexToAddress("0x2a7cdd959bfe8d9487b2a43b33565295a698f7e2"),
		common.HexToAddress("0x2d4c407bbe49438ed859fe965b140dcf1aab71a9"),
		common.HexToAddress("0x3f349bbafec1551819b8be1efea2fc46ca749aa1"),
		common.HexToAddress("0x4430b3230294d12c6ab2aac5c2cd68e80b16b581"),
		common.HexToAddress("0x685b1ded8013785d6623cc18d214320b6bb64759"),
		common.HexToAddress("0x70f657164e5b75689b64b7fd1fa275f334f28e18"),
		common.HexToAddress("0x7ae2f5b9e386cd1b50a4550696d957cb4900f03a"),
		common.HexToAddress("0x8b6c8fd93d6f4cea42bbb345dbc6f0dfdb5bec73"),
		common.HexToAddress("0x9bb832254baf4e8b4cc26bd2b52b31389b56e98b"),
		common.HexToAddress("0x9f8ccdafcc39f3c7d6ebf637c9151673cbc36b88"),
		common.HexToAddress("0xa6f79b60359f141df90a0c745125b131caaffd12"),
		common.HexToAddress("0xb8f7166496996a7da21cf1f1b04d9b3e26a3d077"),
		common.HexToAddress("0xbe807dddb074639cd9fa61b47676c064fc50d62c"),
		common.HexToAddress("0xce2fd7544e0b2cc94692d4a704debef7bcb61328"),
		common.HexToAddress("0xe2d3a739effcd3a99387d015e260eefac72ebea1"),
		common.HexToAddress("0xe9ae3261a475a27bb1028f140bc2a7c843318afd"),
		common.HexToAddress("0xea0a6e3c511bbd10f4519ece37dc24887e11b55d"),
		common.HexToAddress("0xee226379db83cffc681495730c11fdde79ba4c0c"),
	})
	// block 13082001 w/o validators in extra data
	res = doVerifyParliaBlock(t, 56, hexutil.MustDecode("0xf9025ea0eafc056d4cd2355235e385604eb86c9fc3da295a5ac6b292dcd518aad81c96c7a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347947ae2f5b9e386cd1b50a4550696d957cb4900f03aa0250cf7c922d19a3fe86aa873f66847ec81fe3a9dd4b601ff4f3277ac96edbd2fa05df995f5895f9cf4923116c8272b5eff71e719be28fd5033d298d4c3954b3b35a092acd99501495017696d1f32624267613d5fcd1ae61a4316bb8c6f239fd2bb2fb90100f7febfbfe1ff7cdf9fed7fdeff1dbffef5b6bffbfffff76ff7ffafadfe6a77fdfddfaf2c7f7bbdee6fdbfbff6bbdb9fbf9dddbbffeffbffdffffaff9f3efffdff3f7fff9dfffffec7ff7fb7dcf3bfffdff96efffbbfdfcfbffffd7bfbfbffdffefffffe77bbff7fb7fff7dee397ffdffffafdbdfffdbfffffd7b7efffeefcabbbe7ff75fa7f5fbd7ffe7ffffdfabfebfdef79ffffce7dfbd77e3dbfbe1cdfebfebefb7fbebfffe6f719f7ffddffdbc7f7fbffdefbbfffdffffef7fa7fdfdbff7ff3f77e6d7bfdcfff7fefffffebfdfceef2bf65ecf7ff2d7df66fffabeffef77fdffbf5bf9d6fffcfff5f7be7dde9ff7fffef7ffdbfedaffef7ffa779fbf7fff0283c79d918405f5e100840482363c8461a65ec8b861d883010105846765746888676f312e31372e32856c696e7578000000c3167bdf98dad3b5a0c9f6e4f06e7eddec92065c8ba5630305a904d21822a6c15f2cf2e90916c19dfc6ac135021f44179f9dde2fde7904da16c5a488ceae534feec98ab500a00000000000000000000000000000000000000000000000000000000000000000880000000000000000"))
	require.Equal(t, res.signer, common.HexToAddress("0x7ae2f5b9e386cd1b50a4550696d957cb4900f03a"))
	require.Equal(t, res.validators, []common.Address{})
	// block 13131313
	res = doVerifyParliaBlock(t, 56, hexutil.MustDecode("0xf9025ea0a2069ff3eaafb4422687dc653b5b1d687b1c2f318682c691edd5ddca8e38f018a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794a6f79b60359f141df90a0c745125b131caaffd12a0e4a5ac35e132110189e15e43f3b3304a984516366bf1bb11b454254b34f3696ea07c762f669d332b3b92f32c2c61ec5fb657e644866b917fe859bc602994c75601a0ece3f2a18b955f17fe468d8f8c318ca924722c8f32a713802420c05b5f44635eb90100b7fab7d7bf2dbe7fafdbeb7bf3ffadfff6fcdefbfffbf7dfff1edfffff739d77e867ffaadfdadfef779fdf39b9bfd3fffbe7ff93f7dfa7dfb0f78fbfffb77f897fffaf7dbb77ebfe997acf7ef7bf3bff7bb7ffafffdb7fefcde5ffedfefedf3eff6bdd7ff6dffff7ddfdefbfff6ffffefbf7ffeeb4beffe7f7bb63f3fdf3ec6f36bddff7cfb6f1bebcede7ffddbf38adf2f66eff6feedc5b7fe5fbdeffef79ffefffdfb7fadffef7dbebfb9f3e7fdfcbfcffbf2fffe9ff96dff7bf7ffb4feeffefb7ff8edfbfefde75fdffeffffe7d77bf7def7fcf7bebdfbf7cb3ef77f7efdf5dfe7fff7ffff83fefbfdfff1fee3ff7fffeef5afddafa69f67f7cfb7f7ff5f70283c85e318405f5350d840392ab268461a8c55fb861d983010106846765746889676f312e31362e3130856c696e75780000c3167bdf56c8d11fad0da9f8c18f13b49f132be98c5f5bc86f18968cd7197b662f0bdc852e22fc9bf4927ac4406850224da663e8405bf947ffdcd1f8607592831f770d5201a00000000000000000000000000000000000000000000000000000000000000000880000000000000000"))
	require.Equal(t, res.signer, common.HexToAddress("0xa6f79b60359f141df90a0c745125b131caaffd12"))
	require.Equal(t, res.validators, []common.Address{})
	// block 0
	res = doVerifyParliaBlock(t, 56, hexutil.MustDecode("0xf903fca00000000000000000000000000000000000000000000000000000000000000000a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794fffffffffffffffffffffffffffffffffffffffea0919fcc7ad870b53db0aa76eb588da06bacb6d230195100699fc928511003b422a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b901000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001808402625a0080845e9da7ceb9020500000000000000000000000000000000000000000000000000000000000000002a7cdd959bfe8d9487b2a43b33565295a698f7e26488aa4d1955ee33403f8ccb1d4de5fb97c7ade29ef9f4360c606c7ab4db26b016007d3ad0ab86a0ee01c3b1283aa067c58eab4709f85e99d46de5fe685b1ded8013785d6623cc18d214320b6bb6475978f3adfc719c99674c072166708589033e2d9afec2be4ec20253b8642161bc3f444f53679c1f3d472f7be8361c80a4c1e7e9aaf001d0877f1cfde218ce2fd7544e0b2cc94692d4a704debef7bcb61328b8f7166496996a7da21cf1f1b04d9b3e26a3d0772d4c407bbe49438ed859fe965b140dcf1aab71a96bbad7cf34b5fa511d8e963dbba288b1960e75d64430b3230294d12c6ab2aac5c2cd68e80b16b581ea0a6e3c511bbd10f4519ece37dc24887e11b55d7ae2f5b9e386cd1b50a4550696d957cb4900f03a82012708dafc9e1b880fd083b32182b869be8e0922b81f8e175ffde54d797fe11eb03f9e3bf75f1d68bf0b8b6fb4e317a0f9d6f03eaf8ce6675bc60d8c4d90829ce8f72d0163c1d5cf348a862d55063035e7a025f4da968de7e4d7e4004197917f4070f1d6caa02bbebaebb5d7e581e4b66559e635f805ff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000880000000000000000"))
	require.Equal(t, res.signer, common.HexToAddress("0x0000000000000000000000000000000000000000"))
	require.Equal(t, res.validators, []common.Address{
		common.HexToAddress("0x2a7cdd959bfe8d9487b2a43b33565295a698f7e2"),
		common.HexToAddress("0x6488aa4d1955ee33403f8ccb1d4de5fb97c7ade2"),
		common.HexToAddress("0x9ef9f4360c606c7ab4db26b016007d3ad0ab86a0"),
		common.HexToAddress("0xee01c3b1283aa067c58eab4709f85e99d46de5fe"),
		common.HexToAddress("0x685b1ded8013785d6623cc18d214320b6bb64759"),
		common.HexToAddress("0x78f3adfc719c99674c072166708589033e2d9afe"),
		common.HexToAddress("0xc2be4ec20253b8642161bc3f444f53679c1f3d47"),
		common.HexToAddress("0x2f7be8361c80a4c1e7e9aaf001d0877f1cfde218"),
		common.HexToAddress("0xce2fd7544e0b2cc94692d4a704debef7bcb61328"),
		common.HexToAddress("0xb8f7166496996a7da21cf1f1b04d9b3e26a3d077"),
		common.HexToAddress("0x2d4c407bbe49438ed859fe965b140dcf1aab71a9"),
		common.HexToAddress("0x6bbad7cf34b5fa511d8e963dbba288b1960e75d6"),
		common.HexToAddress("0x4430b3230294d12c6ab2aac5c2cd68e80b16b581"),
		common.HexToAddress("0xea0a6e3c511bbd10f4519ece37dc24887e11b55d"),
		common.HexToAddress("0x7ae2f5b9e386cd1b50a4550696d957cb4900f03a"),
		common.HexToAddress("0x82012708dafc9e1b880fd083b32182b869be8e09"),
		common.HexToAddress("0x22b81f8e175ffde54d797fe11eb03f9e3bf75f1d"),
		common.HexToAddress("0x68bf0b8b6fb4e317a0f9d6f03eaf8ce6675bc60d"),
		common.HexToAddress("0x8c4d90829ce8f72d0163c1d5cf348a862d550630"),
		common.HexToAddress("0x35e7a025f4da968de7e4d7e4004197917f4070f1"),
		common.HexToAddress("0xd6caa02bbebaebb5d7e581e4b66559e635f805ff"),
	})
	// latest known block with new validators (15946200)
	res = doVerifyParliaBlock(t, 56, hexutil.MustDecode("0xf90403a062177e38673a43e86ef7804bd5272eaf5f133b9d6ee217c1ef2debca1f614c30a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794ea0a6e3c511bbd10f4519ece37dc24887e11b55da0d45514f56749c9ad5034a1e81dee7ba1c8b2da69ba0525493b4bda3d6e375825a0b8789043c2e8807825077f5620df7df01c2326d4849ba91681a6fba8aab5a710a07c2f5c172d09ad3e10f514b421ce89ce74190e3248d12fc1e3df71e971d0742cb90100e261124194f80d14022b486f980c081ac19cbe7c8c70b2a8d953c63079804794d23d3a1a04409385cf7850313c9423182dc966bb3a1be93157e48c5f33bee7b028e534ad8628a3e2fdc2b0a8f0e3016632560ac5296c3882a57497359bb897005339d838ab02c008b1e3b3a61f73a8a05bc46e5886bd3612223490506f3a36d61016e01db538ee07b39026669991308f602fac45adaebaa9fb091c519de57b3cff6d5f63210461463d00e6109395e406a5228cc121ba47b528bbb216b20c6d5420461143138a412f380d121d58369460f3953224298b7a9b73f1c70e5d2de51852f0d1142d398d740f7d9158170836018510ae2854f6bd48a0b48a0ce05c8c680283f351d88404a2feaa840104cac184622a5b5bb90205d883010107846765746888676f312e31332e34856c696e7578000000c3167bdf2465176c461afb316ebc773c61faee85a6515daa295e26495cef6f69dfa69911d9d8e4f3bbadb89b29a97c6effb8a411dabc6adeefaa84f5067c8bbe2d4c407bbe49438ed859fe965b140dcf1aab71a93f349bbafec1551819b8be1efea2fc46ca749aa1685b1ded8013785d6623cc18d214320b6bb6475970f657164e5b75689b64b7fd1fa275f334f28e1872b61c6014342d914470ec7ac2975be345796c2b7ae2f5b9e386cd1b50a4550696d957cb4900f03a8b6c8fd93d6f4cea42bbb345dbc6f0dfdb5bec739f8ccdafcc39f3c7d6ebf637c9151673cbc36b88a6f79b60359f141df90a0c745125b131caaffd12aacf6a8119f7e11623b5a43da638e91f669a130fac0e15a038eedfc68ba3c35c73fed5be4a07afb5be807dddb074639cd9fa61b47676c064fc50d62cce2fd7544e0b2cc94692d4a704debef7bcb61328e2d3a739effcd3a99387d015e260eefac72ebea1e9ae3261a475a27bb1028f140bc2a7c843318afdea0a6e3c511bbd10f4519ece37dc24887e11b55dee226379db83cffc681495730c11fdde79ba4c0cef0274e31810c9df02f98fafde0f841f4e66a1cd7ee0a297d75806912fb259fe8efd114956704ec64cb790438c76d50e1fed0e921aa98030aa1d6f883d60b77dec2147cb7046ade017ebee5e2e0e4bc6a382391800a00000000000000000000000000000000000000000000000000000000000000000880000000000000000"))
	require.Equal(t, res.signer, common.HexToAddress("0xea0a6e3c511bbd10f4519ece37dc24887e11b55d"))
	require.Equal(t, res.validators, []common.Address{
		common.HexToAddress("0x2465176c461afb316ebc773c61faee85a6515daa"),
		common.HexToAddress("0x295e26495cef6f69dfa69911d9d8e4f3bbadb89b"),
		common.HexToAddress("0x29a97c6effb8a411dabc6adeefaa84f5067c8bbe"),
		common.HexToAddress("0x2d4c407bbe49438ed859fe965b140dcf1aab71a9"),
		common.HexToAddress("0x3f349bbafec1551819b8be1efea2fc46ca749aa1"),
		common.HexToAddress("0x685b1ded8013785d6623cc18d214320b6bb64759"),
		common.HexToAddress("0x70f657164e5b75689b64b7fd1fa275f334f28e18"),
		common.HexToAddress("0x72b61c6014342d914470ec7ac2975be345796c2b"),
		common.HexToAddress("0x7ae2f5b9e386cd1b50a4550696d957cb4900f03a"),
		common.HexToAddress("0x8b6c8fd93d6f4cea42bbb345dbc6f0dfdb5bec73"),
		common.HexToAddress("0x9f8ccdafcc39f3c7d6ebf637c9151673cbc36b88"),
		common.HexToAddress("0xa6f79b60359f141df90a0c745125b131caaffd12"),
		common.HexToAddress("0xaacf6a8119f7e11623b5a43da638e91f669a130f"),
		common.HexToAddress("0xac0e15a038eedfc68ba3c35c73fed5be4a07afb5"),
		common.HexToAddress("0xbe807dddb074639cd9fa61b47676c064fc50d62c"),
		common.HexToAddress("0xce2fd7544e0b2cc94692d4a704debef7bcb61328"),
		common.HexToAddress("0xe2d3a739effcd3a99387d015e260eefac72ebea1"),
		common.HexToAddress("0xe9ae3261a475a27bb1028f140bc2a7c843318afd"),
		common.HexToAddress("0xea0a6e3c511bbd10f4519ece37dc24887e11b55d"),
		common.HexToAddress("0xee226379db83cffc681495730c11fdde79ba4c0c"),
		common.HexToAddress("0xef0274e31810c9df02f98fafde0f841f4e66a1cd"),
	})
	// 200's chapel block
	res = doVerifyParliaBlock(t, 97, hexutil.MustDecode("0xf902d0a056991a71bc79fea816387a6076068274af17e08bbdc81c2f289447f60a19d310a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794980a75ecd1309ea12fa2ed87a8744fbfc9b863d5a0be326f334378264bc98880f49863c9b4a0f1dbce836497a769e19fbfe291dee8a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000281c88401c9c38080845f06d057b8d9d983010000846765746889676f312e31322e3137856c696e75780000000000001284214b9b9c85549ab3d2b972df0deef66ac2c935552c16704d214347f29fa77f77da6d75d7c752980a75ecd1309ea12fa2ed87a8744fbfc9b863d5a2959d3f95eae5dc7d70144ce1b73b403b7eb6e0b71b214cb885500844365e95cd9942c7276e7fd8f474cf03cceff28abc65c9cbae594f725c80e12d3674be94d2b375f63ae71920774699382646cf3ef8ba561a8bfad6f116b8b2e6220792aea7d71c7234d7e1d574948e492b42993dba91a4a9988009d607f0264c01a00000000000000000000000000000000000000000000000000000000000000000880000000000000000"))
	require.Equal(t, res.signer, common.HexToAddress("0x980a75ecd1309ea12fa2ed87a8744fbfc9b863d5"))
	require.Equal(t, res.validators, []common.Address{
		common.HexToAddress("0x1284214b9b9c85549ab3d2b972df0deef66ac2c9"),
		common.HexToAddress("0x35552c16704d214347f29fa77f77da6d75d7c752"),
		common.HexToAddress("0x980a75ecd1309ea12fa2ed87a8744fbfc9b863d5"),
		common.HexToAddress("0xa2959d3f95eae5dc7d70144ce1b73b403b7eb6e0"),
		common.HexToAddress("0xb71b214cb885500844365e95cd9942c7276e7fd8"),
		common.HexToAddress("0xf474cf03cceff28abc65c9cbae594f725c80e12d"),
	})
}
